**Итоговое задание для агента по интеграции платежей Telegram Stars**

На основе предоставленного описания необходимо реализовать полную механику оплаты звёздами Telegram и расширить функционал кнопки «Поделиться с тарологом». В текущей версии приложения после расклада пользователь видит кнопку «Поделиться с тарологом». При её нажатии должен открываться новый экран с выбором одного из трёх тарологов, далее — подтверждение оплаты, списание звёзд, 25-минутный чат и оценка специалиста.

### 1. Общая логика потока

1. **Экран выбора таролога** (новый экран поверх основного, стилизован под общий дизайн: фиолетовый фон, золотые акценты).
   - Отображаются три карточки тарологов. Каждая содержит:
     - Фото таролога (квадратное, можно использовать заглушки).
     - Имя или никнейм.
     - Краткое описание навыков (2–3 предложения).
     - Рейтинг в виде звёзд (от 1 до 5, отображается как сияющие золотые звёзды, полупрозрачные для незаполненных).
     - Текущая цена консультации (в звёздах), рассчитанная по формуле (см. п. 2).
     - Кнопка «Выбрать таролога».
   - Кнопка «Назад» для возврата к результатам расклада.
2. **Модальное окно подтверждения** (появляется после нажатия «Выбрать»):
   - Текст: «Вы соглашаетесь оплатить расшифровку расклада живым специалистом. Стоимость: **X звёзд Telegram**», где X — цена выбранного таролога.
   - Кнопки: «Подтвердить» и «Отмена».
3. **Оплата звёздами Telegram**:
   - При нажатии «Подтвердить» инициируется платёж через Telegram Stars.
   - Общая сумма списания со счёта пользователя равна цене таролога.
   - После успешного платежа сервер должен распределить сумму: 10% (комиссия разработчика) и 90% (перевод тарологу). Поскольку Telegram Stars API пока не поддерживает автоматическое разделение платежа, предлагается следующая схема:
     - Все звёзды поступают на счёт бота (владельца приложения).
     - При успешном платеже сервер фиксирует транзакцию и в фоновом режиме (или по расписанию) переводит 90% от суммы на кошелёк таролога. Для этого необходимо использовать бота-кошелька или ручной перевод (для MVP можно автоматизировать через запрос к API, если Telegram предоставит такую возможность). В документации уточнить.
     - Альтернативно: создать отдельный инвойс для комиссии и для таролога, но это усложнит UX. Пока оставляем схему с пост-обработкой.
   - Требуется серверная часть (Node.js), обрабатывающая вебхуки от Telegram о статусе платежа и выполняющая распределение.
4. **Успешная оплата**:
   - После подтверждения оплаты пользователь автоматически переходит в экран чата с выбранным тарологом.
5. **Чат на 25 минут**:
   - Простой интерфейс чата: отображается имя таролога, аватар, поле ввода, история сообщений (сохраняется только на время сессии).
   - Вверху экрана таймер обратного отсчёта на 25 минут. По истечении времени отправка сообщений блокируется, и через несколько секунд появляется окно оценки.
   - Сообщения передаются через сервер (WebSocket или long polling). Для MVP можно использовать REST с коротким опросом.
   - Таролог получает уведомление в Telegram (через бота) о начале чата и может отвечать.
6. **Экран оценки таролога**:
   - После завершения чата появляется окно с предложением оценить таролога от 1 до 5 звёзд (выбор звёзд, аналогично рейтингу).
   - После выбора оценки отправляется на сервер, обновляется средний рейтинг таролога.
   - Также увеличивается счётчик завершённых сессий для таролога, что влияет на его уровень и будущую цену.
   - Затем показывается благодарность и кнопка «Вернуться к раскладам» или «Закрыть».

### 2. Логика ценообразования (динамическая цена)

- **Базовая начальная цена** для всех тарологов — **33 звезды** (уровень 1).
- **Цена увеличивается на 10% от предыдущего значения** с каждым новым уровнем таролога.
- **Максимальная цена ограничена 333 звездами**.
- **Уровень таролога определяется количеством завершённых сессий**:
  - 0–9 сессий → уровень 1
  - 10–19 сессий → уровень 2
  - 20–29 сессий → уровень 3
  - и так далее.
- **Формула расчёта текущей цены**:
  ```
  level = floor(sessions_completed / 10) + 1
  price = min(33 * (1.1 ^ (level - 1)), 333)
  ```
  Результат округляется до ближайшего целого числа (математическое округление).
- **Хранение в БД**:
  - В таблице `tarologists` хранить `sessions_completed` (INT, DEFAULT 0).
  - Поле `level` не хранить, вычислять по формуле.
  - Цена вычисляется при каждом запросе (например, в API-эндпоинте `/api/tarologists`).
- **Обновление счётчика сессий**:
  - После успешного завершения сессии (когда пользователь выставил оценку) увеличить `sessions_completed` для данного таролога на 1.
  - Это автоматически повлияет на его уровень и цену для будущих клиентов.

**Примеры:**
- Сессий 0 → уровень 1 → цена 33 ⭐
- Сессий 10 → уровень 2 → цена 33 * 1.1 = 36.3 → 36 ⭐
- Сессий 20 → уровень 3 → цена 36 * 1.1 = 39.6 → 40 ⭐
- ...
- Сессий 250 → уровень 26 → цена > 333 → фиксируется 333 ⭐

### 3. Технические требования

#### 3.1. Клиентская часть (JavaScript, CSS, HTML)
- Добавить новые экраны в структуру `index.html` (скрытые дивы, аналогично существующим экранам).
- Стилизовать карточки тарологов, модальное окно, чат, экран оценки в соответствии с общим дизайном (фиолетовый фон, золотые элементы).
- Для отображения рейтинга использовать звёздочки (SVG или иконочный шрифт). Неактивные звёзды полупрозрачные, активные – золотые с эффектом свечения.
- Реализовать таймер на 25 минут в чате (формат MM:SS). По истечении таймера скрыть поле ввода, показать сообщение «Время вышло», через 3 секунды автоматически перейти к окну оценки.
- При нажатии на кнопку «Поделиться с тарологом» переключать экран на экран выбора тарологов, сохраняя текущие данные расклада (карты, текст) для передачи тарологу в начале чата.

#### 3.2. Серверная часть (Node.js + Express)
- Создать API эндпоинты:
  - `GET /api/tarologists` – возвращает массив объектов тарологов с полями: `id`, `name`, `photoUrl`, `description`, `rating`, `price` (вычисленная), `sessionsCompleted`.
  - `POST /api/create-invoice` – принимает `tarologistId`, `userId` (из Telegram), сумму. Создаёт инвойс через Telegram Stars API и возвращает `invoiceLink` клиенту.
  - `POST /api/payment-webhook` – обрабатывает вебхук от Telegram о статусе платежа. При успешном платеже:
    - Записывает транзакцию в БД.
    - Инициирует перевод 90% звёзд тарологу (механизм уточнить, возможно через отдельный запрос или ручное начисление).
    - Создаёт запись о сессии чата.
    - Уведомляет таролога через бота.
  - WebSocket (например, `socket.io`) для обмена сообщениями в чате.
  - `POST /api/rate` – принимает `tarologistId`, `userId`, `rating` (1-5). Обновляет средний рейтинг таролога и увеличивает `sessionsCompleted` на 1.
- База данных: SQLite или PostgreSQL. Таблицы:
  - `tarologists` (id, name, photo_url, description, rating, total_ratings, sessions_completed, telegram_id)
  - `users` (id, telegram_id, username)
  - `transactions` (id, user_id, tarologist_id, amount, stars_amount, status, created_at)
  - `chat_sessions` (id, user_id, tarologist_id, start_time, end_time, active)
  - `messages` (id, session_id, sender_id, text, timestamp)
- Интеграция с Telegram Bot API:
  - Использовать токен бота.
  - Для создания инвойса: метод `sendInvoice` с параметром `provider_token = "STARS"`. Возвращает `invoice_link`, который открывается на клиенте через `window.Telegram.WebApp.openInvoice`.
  - Вебхук настроить на URL сервера.
  - Для уведомления таролога: `sendMessage` с информацией о новом клиенте и ссылкой на чат (возможно через WebApp).

#### 3.3. Взаимодействие клиента и сервера
- Клиент загружает список тарологов при открытии экрана выбора.
- При выборе таролога и подтверждении клиент отправляет `POST /api/create-invoice`, получает ссылку и открывает её.
- После успешной оплаты (вебхук или опрос статуса) клиент переходит в чат.
- Чат: подключение к WebSocket, отправка/получение сообщений в реальном времени. Для упрощения можно использовать REST с периодическим опросом.
- По окончании чата клиент отправляет оценку на `POST /api/rate`.

### 4. Важные замечания
- **Аутентификация:** Все запросы должны проверять подпись Telegram (`initData`). Передавать `initData` на сервер для валидации.
- **Тестирование:** Использовать тестовую среду Telegram (тестовые звёзды).
- **Дизайн:** Все новые окна должны соответствовать общей стилистике (мистический фиолетовый, золото, те же шрифты).
- **Производительность:** Изображения тарологов оптимизировать (WebP).
- **Безопасность:** На стороне сервера проверять, что платежи совершаются от реальных пользователей и не дублируются.

### 5. Что должно быть предоставлено в результате
- Полный код клиентской части (изменения в `index.html`, `style.css`, новые JS-модули).
- Полный код серверной части (файлы: `server.js`, маршруты, контроллеры, модели БД).
- Инструкция по настройке переменных окружения (токен бота, параметры БД) и запуску.
- Описание структуры базы данных.

### Примечание по распределению звёзд
На данный момент Telegram не предоставляет автоматического расщепления платежа между несколькими получателями. Предлагается следующее решение:
- После успешного платежа (все звёзды поступают на счёт бота) сервер фиксирует транзакцию.
- Периодически (или сразу) бот переводит 90% от суммы на счёт таролога, используя метод `sendInvoice` с указанием получателя — таролога, но это создаст новый платёж. Альтернативно, можно использовать переводы через бота-кошелька, если Telegram предоставит API для переводов между пользователями. Пока документация по Stars не содержит методов для перевода между пользователями, поэтому в MVP можно реализовать ручное начисление или накапливать комиссию и выплачивать вручную. Однако в задании предполагается автоматическое распределение, поэтому необходимо изучить актуальные возможности API и предложить рабочее решение. Если технически невозможно, сделать пометку о необходимости ручного перевода.

**Конец задания.**